<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mini Social App</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      color: #333;
    }
    .dark-mode {
      background-color: #121212;
      color: #eee;
    }
    .container {
      max-width: 600px;
      margin: auto;
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
    }
    input, textarea, button, select {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #2196f3;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #1976d2;
    }
    .post, .comment, .profile {
      background-color: white;
      margin: 10px 0;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .dark-mode .post, .dark-mode .comment, .dark-mode .profile {
      background-color: #1e1e1e;
      color: #eee;
    }
    .flex {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    img.preview, img.profile-pic {
      max-width: 100%;
      margin-top: 10px;
      border-radius: 5px;
    }
    img.profile-pic {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
    }
    .hidden {
      display: none;
    }
    @media (max-width: 600px) {
      .container {
        padding: 10px;
      }
      input, textarea, button {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Mini Social App</h1>
    <div class="flex">
      <button onclick="toggleDarkMode()">Toggle Dark Mode</button>
     <a href="profile.html"><button>My Profile</button></a>

    </div>

    <!-- Auth Section -->
    <div id="auth-section">
      <h2>Register</h2>
      <input type="text" id="reg-username" placeholder="Username">
      <input type="email" id="reg-email" placeholder="Email">
      <input type="password" id="reg-password" placeholder="Password">
      <button onclick="register()">Register</button>

      <h2>Login</h2>
      <input type="text" id="login-username" placeholder="Username"/>
      <input type="password" id="login-password" placeholder="Password"/>
      <button onclick="login()">Login</button>
    </div>

    <!-- App Section -->
    <div id="app-section" class="hidden">
      <h2>Welcome, <span id="currentUser"></span></h2>
      <button onclick="logout()">Logout</button>

      <h3>Create Post</h3>
      <textarea id="post-content" placeholder="What's on your mind?"></textarea>
      <input type="file" id="post-image" accept="image/*" />
      <img id="image-preview" class="preview hidden" />
      <button onclick="createPost()">Post</button>

      <h3>Feed</h3>
      <div id="posts"></div>
    </div>

    <!-- Profile Section -->
    <div id="profile-section" class="hidden">
      <h2>Your Profile</h2>
      <img id="profile-pic" class="profile-pic" src="" alt="Profile Picture" />
      <input type="file" id="upload-pic" accept="image/*" onchange="uploadProfilePic(event)" />
      <p><strong>Username:</strong> <span id="profile-username"></span></p>
      <p><strong>Email:</strong> <span id="profile-email"></span></p>
      <p><strong>Followers:</strong> <span id="profile-followers"></span></p>
      <p><strong>Following:</strong> <span id="profile-following"></span></p>

      <h3>Edit Profile</h3>
      <input type="text" id="edit-username" placeholder="New Username">
      <button onclick="updateProfile()">Save Changes</button>

      <h3>Your Posts</h3>
      <div id="user-posts"></div>

      <button onclick="backToFeed()">Back to Feed</button>
    </div>
  </div>

  <script>
    const API_URL = "http://localhost:5000";

    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
    }

    function previewImage(event) {
      const reader = new FileReader();
      reader.onload = function () {
        const img = document.getElementById("image-preview");
        img.src = reader.result;
        img.classList.remove("hidden");
      };
      reader.readAsDataURL(event.target.files[0]);
    }

    document.getElementById("post-image").addEventListener("change", previewImage);

  async function register() {
    const username = document.getElementById("reg-username").value;
    const email = document.getElementById("reg-email").value;
    const password = document.getElementById("reg-password").value;

    try {
      const res = await fetch(`${API_URL}/api/users/register`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, email, password })
      });

      const data = await res.text();

      if (res.ok) {
        alert("Registered successfully!");
        window.location.href = "profile.html"; // üîÅ Go to next page after success
      } else {
        alert("Registration failed: " + data);
      }
    } catch (err) {
      console.error("Error:", err);
      alert("Something went wrong!");
    }
  }
  async function login() {
    console.log(document.getElementById("login-username"));
    const username= document.getElementById("login-username").value;
    const password = document.getElementById("login-password").value;

    try {
      const res = await fetch(`${API_URL}/api/users/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password })
      });

      const data = await res.json();

      if (res.ok) {
        alert("Login successful");
        // Save login info to localStorage
        localStorage.setItem("user", JSON.stringify(data.user));
        window.location.href = "profile.html"; // go to profile page
      } else {
        alert("Login failed: " + data.message);
      }
    } catch (err) {
      alert("Error logging in");
    }
  }
    function logout() {
      localStorage.clear();
      location.reload();
    }

    function showApp() {
      document.getElementById("auth-section").classList.add("hidden");
      document.getElementById("app-section").classList.remove("hidden");
      document.getElementById("currentUser").textContent = localStorage.getItem("username");
      fetchPosts();
    }

    async function createPost() {
      const content = document.getElementById("post-content").value;
      const userId = localStorage.getItem("userId");
      const imageFile = document.getElementById("post-image").files[0];

      const formData = new FormData();
      formData.append("content", content);
      formData.append("userId", userId);
      if (imageFile) formData.append("image", imageFile);

      await fetch(`${API_URL}/api/posts`, {
        method: "POST",
        body: formData
      });

      document.getElementById("post-content").value = "";
      document.getElementById("post-image").value = "";
      document.getElementById("image-preview").classList.add("hidden");
      fetchPosts();
    }

    async function fetchPosts() {
      const res = await fetch(`${API_URL}/api/posts`);
      const posts = await res.json();
      const postDiv = document.getElementById("posts");
      postDiv.innerHTML = posts.map(post => `
        <div class="post">
          <strong>${post.createdBy.username}</strong><br>
          ${post.imageUrl ? `<img src="${post.imageUrl}" class="preview">` : ""}<br>
          ${post.content}<br>
          ‚ù§Ô∏è ${post.likes.length} 
          <button onclick="likePost('${post._id}')">Like</button><br>
          <input placeholder="Write a comment" id="comment-${post._id}" />
          <button onclick="commentPost('${post._id}')">Comment</button>
          <div>${post.comments.map(c => `<div class="comment"><strong>${c.username}</strong>: ${c.text}</div>`).join("")}</div>
        </div>
      `).join("");
    }

    async function likePost(postId) {
      const userId = localStorage.getItem("userId");
      await fetch(`${API_URL}/api/posts/${postId}/like`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId })
      });
      fetchPosts();
    }

    async function commentPost(postId) {
      const input = document.getElementById(`comment-${postId}`);
      const text = input.value;
      const userId = localStorage.getItem("userId");
      await fetch(`${API_URL}/api/posts/${postId}/comment`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId, text })
      });
      input.value = "";
      fetchPosts();
    }

    async function showProfile() {
      const userId = localStorage.getItem("userId");
      const res = await fetch(`${API_URL}/api/users/${userId}`);
      const data = await res.json();

      document.getElementById("app-section").classList.add("hidden");
      document.getElementById("profile-section").classList.remove("hidden");

      document.getElementById("profile-username").textContent = data.username;
      document.getElementById("profile-email").textContent = data.email;
      document.getElementById("profile-followers").textContent = data.followers.length;
      document.getElementById("profile-following").textContent = data.following.length;
      document.getElementById("profile-pic").src = data.profilePic || "https://via.placeholder.com/80";
      document.getElementById("edit-username").value = data.username;

      const userPosts = data.posts || [];
      document.getElementById("user-posts").innerHTML = userPosts.map(post => `
        <div class="post">
          ${post.imageUrl ? `<img src="${post.imageUrl}" class="preview">` : ""}<br>
          ${post.content}
        </div>
      `).join("");
    }

    function backToFeed() {
      document.getElementById("profile-section").classList.add("hidden");
      document.getElementById("app-section").classList.remove("hidden");
    }

    async function updateProfile() {
      const userId = localStorage.getItem("userId");
      const username = document.getElementById("edit-username").value;

      await fetch(`${API_URL}/api/users/${userId}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username })
      });
      showProfile();
    }

    async function uploadProfilePic(event) {
      const userId = localStorage.getItem("userId");
      const file = event.target.files[0];
      const formData = new FormData();
      formData.append("profilePic", file);

      await fetch(`${API_URL}/api/users/${userId}/upload-pic`, {
        method: "POST",
        body: formData
      });
      showProfile();
    }

    if (localStorage.getItem("token")) {
      showApp();
    }
  </script>
</body>
</html>
